# AFMTools QM Input File Generation Scripts Documentation

This documentation provides detailed information about the scripts in the `scr_QMMM_inp/` directory, which are used to create input files for various quantum mechanical (QM) software packages including Gaussian, Molpro, GAMESS, ORCA, and PQS from .pxyz coordinate files.

## Overview

These tools convert QM/MM selections (created with `scr_QMMM_select/` tools) into properly formatted input files for quantum chemistry calculations. They handle geometry updates, charge lattice generation, and software-specific formatting requirements.

## Key Concepts

### Template Files
- Pre-written input files with placeholder sections that get replaced with actual molecular data
- Contain software-specific keywords, basis sets, and calculation parameters
- Located in `translation_file/` directory with examples for each QM package

### Translation Files
Two types of translation files map molecular data to QM software requirements:

1. **Name Translation Files** (`.nucinfo`): Map atom names from .pxyz files to standard element symbols or software-specific labels
2. **Charge Information Files** (`.chginfo`): Provide partial charges for MM atoms in QM/MM calculations

### File Format Structure

**.pxyz format**: `atomname x y z molname mark`
- Used as input for all tools
- Generated by `scr_QMMM_select/` tools

**Template keywords**:
- `GEOMETRY` - Placeholder for QM atom coordinates
- `charge_latt` - Placeholder for MM point charges
- Software-specific sections vary by package

## Gaussian Tools

### pxyz_gaussian_upd_geom
**Purpose**: Updates the geometry section in Gaussian input files with coordinates from .pxyz files

**Usage**: `pxyz_gaussian_upd_geom gaussian.inp name_translation [file.pxyz]`

**Input**:
- `gaussian.inp`: Gaussian template file containing `GEOMETRY` keyword
- `name_translation`: File mapping .pxyz atom names to standard element symbols
- `.pxyz` file: Coordinate data (via stdin or file argument)

**Output**: Complete Gaussian input file to stdout with updated geometry section

**Details**:
- Searches for `GEOMETRY` keyword (case-insensitive) in template
- Replaces placeholder geometry with actual coordinates from .pxyz file
- Translates atom names using name_translation file
- Warns if atom names are not found in translation file
- Preserves all other template content unchanged

**Example**:
```bash
pxyz_gaussian_upd_geom template.gjf gaussian.nucinfo system.pxyz > input.gjf
```

### pxyz_gaussian_upd_lattice
**Purpose**: Updates the charge lattice section in Gaussian input files for QM/MM calculations

**Usage**: `pxyz_gaussian_upd_lattice gaussian.inp charge_info [file.pxyz]`

**Input**:
- `gaussian.inp`: Gaussian template file containing `charge_latt` keyword
- `charge_info`: File providing partial charges for atom types
- `.pxyz` file: Coordinate data (via stdin or file argument)

**Output**: Complete Gaussian input file to stdout with updated charge lattice

**Details**:
- Searches for `charge_latt` keyword (case-insensitive) in template
- Creates point charge array with format: `x y z charge`
- Uses high precision formatting (16.8f) for coordinates and charges
- Dies with error if charge not found for any atom type
- Essential for QM/MM calculations with MM point charges

**Example**:
```bash
pxyz_gaussian_upd_lattice template.gjf gaussian.chginfo mm_atoms.pxyz > qmmm.gjf
```

## Molpro Tools

### pxyz_molpro_upd_geom
**Purpose**: Updates the geometry section in Molpro input files

**Usage**: `pxyz_molpro_upd_geom template.inp name_translation [file.pxyz]`

**Input**:
- `template.inp`: Molpro template file with `GEOMETRY` block
- `name_translation`: Atom name translation file
- `.pxyz` file: Coordinate data (via stdin or file argument)

**Output**: Complete Molpro input file to stdout with updated geometry

**Details**:
- Searches for `GEOMETRY` keyword in template
- Uses Molpro-specific format: `element, x, y, z` (comma-separated)
- Adds atom count and comment line after GEOMETRY keyword
- Preserves geometry block structure with closing `}`
- Maintains all other Molpro input directives

**Example**:
```bash
pxyz_molpro_upd_geom template.inp molpro.nucinfo system.pxyz > calculation.inp
```

### pxyz_molpro_gen_lattice
**Purpose**: Generates charge lattice files for Molpro QM/MM calculations

**Usage**: `pxyz_molpro_gen_lattice charge_info [file.pxyz]`

**Input**:
- `charge_info`: File with partial charges and optional flags
- `.pxyz` file: Coordinate data (via stdin or file argument)

**Output**: Molpro-formatted charge lattice to stdout

**Details**:
- Creates standalone charge lattice file (not template update)
- Format: `x, y, z, charge, flag` (comma-separated)
- Supports three-column charge_info: `atomname charge flag`
- Default flag value is 0 if not specified
- Used as external file referenced by main Molpro input

**Example**:
```bash
pxyz_molpro_gen_lattice molpro.chginfo mm_charges.pxyz > lattice.inp
```

## GAMESS Tools

### pxyz_gms_upd_geom
**Purpose**: Updates the QM geometry section in GAMESS input files

**Usage**: `pxyz_gms_upd_geom template.in nuclear_charge_info [file.pxyz]`

**Input**:
- `template.in`: GAMESS template file with `$DATA` section
- `nuclear_charge_info`: File with atomic numbers and optional QM names
- `.pxyz` file: Coordinate data (via stdin or file argument)

**Output**: Complete GAMESS input file to stdout

**Details**:
- Searches for `$DATA` section in template
- Preserves molecule name and symmetry lines from template
- Format: `atomname+mark atomicnumber x y z`
- Appends mark value to atom names for identification
- Three-column nucinfo format: `atomname atomicnumber [QMname]`
- Dies with error if atomic number not found for any atom

**Example**:
```bash
pxyz_gms_upd_geom template.inp gms.nucinfo qm_region.pxyz > gamess.inp
```

### pxyz_gms_upd_frag
**Purpose**: Generates EFP fragment section for GAMESS QM/MM calculations

**Usage**: `pxyz_gms_upd_frag template.inp charge_info [file.pxyz]`

**Input**:
- `template.inp`: GAMESS template with `$EFRAG` section
- `charge_info`: Partial charge information file
- `.pxyz` file: MM coordinate data (via stdin or file argument)

**Output**: Complete GAMESS input with EFP fragment section

**Details**:
- Handles MM charges through EFP (Effective Fragment Potential) method
- Converts coordinates from Angstrom to Bohr (multiply by 1.8897259885789233)
- Creates three sections: coordinate definition, fragment coordinates, monopoles
- Adds unique identifiers to atoms (e.g., "C0M0", "H1M1")
- **Limitation**: Only works if all charges fit within one EFP fragment
- Essential for GAMESS QM/MM calculations with point charges

**Example**:
```bash
pxyz_gms_upd_frag template.inp gms.chginfo mm_region.pxyz > qmmm_gamess.inp
```

## ORCA Tools

### pxyz_orca_upd_xyz
**Purpose**: Updates the coordinate section in ORCA input files

**Usage**: `pxyz_orca_upd_xyz template.inp name_translation [file.pxyz]`

**Input**:
- `template.inp`: ORCA template file with `*xyz` section
- `name_translation`: Atom name translation file
- `.pxyz` file: Coordinate data (via stdin or file argument)

**Output**: Complete ORCA input file to stdout

**Details**:
- Searches for `*xyz` keyword marking coordinate section
- Format: `element x y z #atomnumber`
- Adds sequential atom numbering as comments
- Continues reading template until `Q` or `*` (end markers)
- Preserves all ORCA calculation directives and parameters

**Example**:
```bash
pxyz_orca_upd_xyz template.inp orca.nucinfo qm_atoms.pxyz > orca_calc.inp
```

### pxyz_orca_upd_chg
**Purpose**: Updates the MM charge section in ORCA QM/MM input files

**Usage**: `pxyz_orca_upd_chg template.inp charge_info [file.pxyz]`

**Input**:
- `template.inp`: ORCA template with existing `*xyz` section and `Q` charges
- `charge_info`: Partial charge information file
- `.pxyz` file: MM coordinate data (via stdin or file argument)

**Output**: Complete ORCA QM/MM input file to stdout

**Details**:
- Updates charges in existing `*xyz` section (not standalone)
- Format: `Q charge x y z` (with optional `$` freeze markers)
- Skips to existing `Q` section in template
- Variable `$frz` controls coordinate freezing (default: "$")
- Set `$frz=""` in script to disable freezing
- Dies with error if charge not found for any atom

**Example**:
```bash
pxyz_orca_upd_chg qm_template.inp orca.chginfo mm_charges.pxyz > qmmm_orca.inp
```

## PQS Tools

### pxyz_pqs_gen_xyz
**Purpose**: Generates XYZ coordinate files for PQS calculations

**Usage**: `pxyz_pqs_gen_xyz name_translation [file.pxyz]`

**Input**:
- `name_translation`: Atom name translation file (can map to special characters)
- `.pxyz` file: Coordinate data (via stdin or file argument)

**Output**: PQS-formatted XYZ coordinates to stdout

**Details**:
- Creates standalone coordinate file (not full input)
- Uses atomic units (coordinates assumed already in atomic units)
- Supports special character suffixes in QM names (e.g., "H@", "C@")
- Format: `atomname x y z` (10-character width for names)
- Used with PQS `GEOM=pqs FILE=filename` directive

**Example**:
```bash
pxyz_pqs_gen_xyz pqs.nucinfo qm_system.pxyz > coords.xyz
```

### pxyz_pqs_gen_pntq
**Purpose**: Generates point charge files for PQS QM/MM calculations

**Usage**: `pxyz_pqs_gen_pntq charge_info [file.pxyz]`

**Input**:
- `charge_info`: Partial charge file with optional dummy atom types
- `.pxyz` file: MM coordinate data (via stdin or file argument)

**Output**: PQS point charge file to stdout

**Details**:
- Creates standalone point charge file
- Format: `dummy_type x y z charge`
- Three-column charge_info: `atomname charge [dummy_type]`
- Default dummy type is "Q" if not specified
- Includes atom count and "an" identifier for PQS
- Used with PQS `pntq` directive in main input

**Example**:
```bash
pxyz_pqs_gen_pntq pqs.chginfo mm_region.pxyz > charges.pntq
```

## Utility Tools

### molpro_replace_field
**Purpose**: Updates comma-separated fields in Molpro input files

**Usage**: `molpro_replace_field keyword newvalue [molpro.inp]`

**Input**:
- `keyword`: Text pattern to search for in comma-separated lines
- `newvalue`: Replacement value for matching field
- `molpro.inp`: Molpro input file (via stdin or file argument)

**Output**: Modified Molpro input to stdout

**Details**:
- Processes lines containing the keyword
- Splits lines by commas, replaces matching fields
- Useful for updating filenames, parameters, or options
- Commonly used to update `LATTICE, INFILE=filename` directives
- Only modifies lines containing the keyword

**Example**:
```bash
molpro_replace_field "INFILE" "new_lattice.inp" template.inp > updated.inp
```

### pqs_replace_field
**Purpose**: Updates space-separated fields in PQS input files

**Usage**: `pqs_replace_field keyword newvalue [pqs.inp]`

**Input**:
- `keyword`: Text pattern to search for in space-separated lines
- `newvalue`: Replacement value for matching field
- `pqs.inp`: PQS input file (via stdin or file argument)

**Output**: Modified PQS input to stdout

**Details**:
- Similar to molpro_replace_field but for space-separated format
- Processes lines containing the keyword
- Splits lines by whitespace, replaces matching fields
- Useful for updating `FILE=filename` or other PQS directives
- Only modifies lines containing the keyword

**Example**:
```bash
pqs_replace_field "FILE" "new_coords.xyz" template.inp > updated.inp
```

## Translation Files Reference

### Name Translation Files (.nucinfo)
**Purpose**: Map .pxyz atom names to QM software element symbols

**Format**:
```
# Comments start with #
atomname    element_symbol
H1          H
CA          C
OW          O
```

**Usage**:
- First column: atom name as it appears in .pxyz file
- Second column: standard element symbol or software-specific name
- Comments allowed anywhere (lines starting with #)
- Used by geometry update tools

### Charge Information Files (.chginfo)
**Purpose**: Provide partial charges for MM atoms in QM/MM calculations

**Format**:
```
# Comments start with #
atomname    charge    [optional_flag/dummy_type]
HW1         0.4238
OW         -0.8476
MW         -1.3290    Q
```

**Usage**:
- First column: atom name as it appears in .pxyz file
- Second column: partial charge value
- Third column (optional): software-specific flags or dummy atom types
- Used by charge lattice generation tools

## Template Files Reference

### Template Structure
All template files contain:
1. **Header**: Software-specific calculation parameters, basis sets, memory
2. **Placeholder sections**: Keywords that get replaced with molecular data
3. **Footer**: Additional directives, post-processing instructions

### Software-Specific Keywords

**Gaussian**: `GEOMETRY`, `charge_latt`
**Molpro**: `GEOMETRY` (within `{}` blocks)  
**GAMESS**: `$DATA` section
**ORCA**: `*xyz` section, `Q` charges
**PQS**: External file references

## Typical QM/MM Workflow

1. **Generate QM/MM selection**:
   ```bash
   # Create QM/MM partitioning (see scr_QMMM_select documentation)
   python 02_gen_pxyz.py  # Creates final.pxyz with marked regions
   ```

2. **Extract regions**:
   ```bash
   pxyz_select 4 final.pxyz > qm_center.pxyz     # QM center molecule
   pxyz_select 3 final.pxyz > qm_fitting.pxyz    # QM fitting region  
   pxyz_select 1 final.pxyz > mm_charges.pxyz    # MM point charges
   ```

3. **Generate QM input**:
   ```bash
   # For Gaussian
   pxyz_gaussian_upd_geom template.gjf gaussian.nucinfo qm_center.pxyz > step1.gjf
   pxyz_gaussian_upd_lattice step1.gjf gaussian.chginfo mm_charges.pxyz > final.gjf
   
   # For Molpro  
   pxyz_molpro_upd_geom template.inp molpro.nucinfo qm_center.pxyz > main.inp
   pxyz_molpro_gen_lattice molpro.chginfo mm_charges.pxyz > charges.inp
   molpro_replace_field "INFILE" "charges.inp" main.inp > final.inp
   
   # For ORCA
   pxyz_orca_upd_xyz template.inp orca.nucinfo qm_center.pxyz > step1.inp
   pxyz_orca_upd_chg step1.inp orca.chginfo mm_charges.pxyz > final.inp
   ```

4. **Run calculation and extract results** (see scr_ref documentation)

## Important Notes

### File Handling
- Most tools read from stdin if no input file specified
- All tools write to stdout (redirect to save results)
- Template files are read but not modified
- Translation files must exist (tools die if missing)

### Error Handling
- Tools die with descriptive errors for missing files
- Warnings issued for unmapped atom names (continue processing)
- Missing charges cause immediate termination
- Always check stderr for warnings

### Coordinate Units
- .pxyz files use Angstrom units
- Most QM software expects Angstrom (no conversion needed)
- GAMESS EFP fragments convert to Bohr automatically
- PQS tools assume atomic units in input

### Software Compatibility
- Templates must match software version requirements
- Basis set and method specifications vary by package
- Memory and parallelization settings are software-specific
- Always validate generated inputs before expensive calculations

### Performance Considerations
- Tools are fast for typical molecular systems (< 1000 atoms)
- Large MM regions may require memory optimization
- Template file size doesn't significantly affect performance
- Translation file lookup is efficient for reasonable system sizes

This toolset provides a complete workflow for generating quantum chemistry input files from QM/MM molecular selections, supporting the major quantum chemistry packages used in computational chemistry research.