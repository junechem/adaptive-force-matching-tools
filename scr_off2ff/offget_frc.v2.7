#!/usr/bin/perl

# offget_frc.v2.7 - Extract force data from OFF files (version 2.7+ format)
#
# Version-specific script for extracting force components from OFF files with
# RefIdx sections using the current column layout from AFMTools version 2.7+.

if (@ARGV < 1 || $ARGV[0] eq '-h' || $ARGV[0] eq '--help') {
    print_help();
    exit(@ARGV < 1 ? 1 : 0);
}

sub print_help {
    print << 'EOF';

NAME
    offget_frc.v2.7 - Extract force data from OFF files (version 2.7+ format)

PURPOSE
    This script extracts force components (X, Y, Z) from OFF files containing
    RefIdx sections using the current column layout from AFMTools version 2.7
    and later. This version uses the same column positions as the main
    offget_frc script.

USAGE
    offget_frc.v2.7 file.off [force_type] [interaction_filter]

PARAMETERS
    file.off           - Input OFF file containing RefIdx section (v2.7+ format)
    force_type         - Type of forces to extract (default: "fit")
                        • "ref": Reference forces from QM calculations
                        • "fit": Fitted forces from force field
                        • "dif": Force differences (ref - fit)
    interaction_filter - Optional filter for specific interactions

INPUT
    • OFF file with RefIdx section (version 2.7+ format)
    • RefIdx entries with current column layout
    • Force data positioned 4, 3, and 2 columns from end

OUTPUT
    • Three-column force data: "ForceX  ForceY  ForceZ"
    • One line per reference point/interaction
    • Forces filtered by interaction type if specified

DETAILS
    Version 2.7+ column positions:
    - Reference forces: 4th-to-last column
    - Fitted forces: 3rd-to-last column  
    - Force differences: 2nd-to-last column

    This matches the current standard format used in the main offget_frc
    script and represents the current OFF file format specification.

EXAMPLES
    offget_frc.v2.7 system.off
        Extract fitted forces using v2.7+ column layout

    offget_frc.v2.7 system.off ref
        Extract reference forces using current format

COMPATIBILITY
    Use this version when working with:
    • AFMTools version 2.7 and later output files
    • Current OFF file format specifications
    • New force field optimization workflows

NOTE
    This script is functionally equivalent to the main offget_frc script
    and is provided for explicit version compatibility and documentation.

EOF
}

$off=$ARGV[0];shift;
$which=$ARGV[0];shift;
$inter=$ARGV[0];shift;
$which="fit" unless defined($which);

open (REF,$off);
while(<REF>)
{
if (/RefIdx/) {
$ind=1;

while ($ind >0 ){

  $_=<REF>;chomp;
  @nrec=split;
  $ind=substr($nrec[1],0,1);
 # print $_."\n";
  $prt=1;
  if ( defined($inter) ){ $prt=0 unless $nrec[1] =~ /$inter/i; }
  $fx=$nrec[@nrec-4] if $which =~ /ref/i;
  $fx=$nrec[@nrec-3] if $which =~ /fit/i;
  $fx=$nrec[@nrec-2] if $which =~ /dif/i;
  for ($i=0;$i<2;$i++) {
    $_=<REF>;chomp;
    @nrec=split;
    $f[$i]=$nrec[@nrec-4] if $which =~ /ref/i;
    $f[$i]=$nrec[@nrec-3] if $which =~ /fit/i;
    $f[$i]=$nrec[@nrec-2] if $which =~ /dif/i;
  }

#  print $prt."\n";
  print $fx."  ".$f[0]."   ".$f[1]."\n" if $ind >0 and $prt==1;
#  $_=<REF>;
}

}
}


